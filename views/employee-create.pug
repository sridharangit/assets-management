extends layout

block content
  .p-4
    .card.shadow-sm.rounded-4.p-3
      h4.fw-bold.mb-3.text-dark #{editMode ? 'Edit Employee' : 'Add Employee'}
      div#alertBox.alert-box.mb-3.mt-3
      form#employeeForm
        input(type="hidden" name="id" id="empId")

        .row.mb-3
          .col-md-4
            label.form-label Name *
            input#empName.form-control(type="text" name="name" maxlength="50" required placeholder="Enter employee name")
          .col-md-4
            label.form-label Email ID *
            input#empEmail.form-control(type="email" name="email" maxlength="50" required placeholder="Enter employee email")
          .col-md-4
            label.form-label Mobile No *
            input#empMobile.form-control(type="mobile" name="mobile" maxlength="50" required placeholder="Enter employee mobile")
        .row.mb-3
          .col-md-4
            label.form-label Branch
            input#empBranch.form-control(type="text" name="branch" maxlength="50" placeholder="Enter branch")
          .col-md-4.d-flex.align-items-center
            .form-check
              input#empStatus.form-check-input(type="checkbox" name="status" checked)
              label.form-check-label.ms-2(for="empStatus") Active

        button#submitBtn.btn.btn-primary.mt-3(type="submit") #{editMode ? 'Update Employee' : 'Create Employee'}

  script.
    document.addEventListener('DOMContentLoaded', () => {
      const empName   = document.getElementById('empName');
      const empEmail  = document.getElementById('empEmail');
      const empMobile = document.getElementById('empMobile');
      const empBranch = document.getElementById('empBranch');
      const empStatus = document.getElementById('empStatus');
      const submitBtn = document.getElementById('submitBtn');
      const form      = document.getElementById('employeeForm');
      const alertBox  = document.getElementById('alertBox');

      function showMessage(text, type){
        alertBox.innerText = text;
        alertBox.className = 'alert-box ' + type;
        alertBox.style.display = 'block';
      }

      const urlParams = new URLSearchParams(window.location.search);
      const editMode  = urlParams.has('id');

      if(editMode){
        const id = urlParams.get('id');
        fetch(`/employee/get/${id}`)
          .then(res => res.json())
          .then(data => {
            if(data.success){
              const emp = data.employee;
              document.getElementById('empId').value = emp.employee_id;
              empName.value   = emp.c_name ?? '';
              empEmail.value  = emp.c_email ?? '';
              empBranch.value = emp.c_branch ?? '';
              empMobile.value = emp.c_mobile ?? '';
              empStatus.checked = emp.n_status === 1;
              submitBtn.innerText = 'Update Employee';
            } else {
              showMessage('Error: ' + data.error, 'error');
            }
          })
          .catch(err => {
            console.error(err);
            showMessage('Error loading employee data.', 'error');
          });
      }

      form.addEventListener('submit', function(e){
        e.preventDefault();

        const payload = {
          name: empName.value.trim(),
          email: empEmail.value.trim(),
          branch: empBranch.value.trim(),
          mobile: empMobile.value,
          status: empStatus.checked ? 1 : 0
        };

        const id  = document.getElementById('empId').value;
        const url = id ? `/employee/edit/${id}` : '/employee/create';

        fetch(url, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(res => {
          if(res.success){
            showMessage(id ? 'Employee updated successfully!' : 'Employee created successfully!', 'success');
            setTimeout(() => window.location.href = '/employee', 1000);
          } else {
            showMessage('Error: ' + res.error, 'error');
          }
        })
        .catch(err => {
          console.error(err);
          showMessage('An error occurred while saving.', 'error');
        });
      });
    });

