extends layout

block content
  .p-4
    .card.shadow-sm.rounded-4.p-3
      div.display-flex
        h4.fw-bold.mb-3.text-dark Employee List

        a.btn.btn-primary.mb-3.rounded-3(href="/employee/create" style="float: right;margin-top: -27px;")
          i.bi.bi-person-plus-fill.me-2
          | Add Employee

      .d-flex.mb-3.align-items-center.g-3
        label.me-2.mb-0(for="statusFilter") Filter:
        select#statusFilter.form-select.me-4(style="width:200px")
          option(value="all" selected) All
          option(value="1") Active
          option(value="0") Inactive

        label.me-2.mb-0(for="nameSearch") Search:
        input#nameSearch.form-control(style="width:200px" placeholder="Search by name")

      table#empTable.table.table-striped.table-bordered.align-middle
        thead.bg-dark.text-white
          tr
            th #
            th Name
            th Email
            th Branch
            th Status
            th Action
        tbody
          each emp, i in employee
            tr
              td #{i + 1}
              td #{emp.c_name}
              td #{emp.c_email}
              td #{emp.c_branch}
              td
                if emp.n_status == 1
                  span.badge.bg-success Active
                else
                  span.badge.bg-secondary Inactive
              td
                button.btn.btn-sm.btn-warning.me-2(type="button" onclick=`editEmployee(${emp.employee_id})`)
                  i.bi.bi-pencil-fill
                button.btn.btn-sm.btn-danger(type="button" onclick=`showDeleteModal(${emp.employee_id})`)
                  i.bi.bi-trash-fill

  div#deleteModal.modal.fade(tabindex="-1" aria-hidden="true")
    div.modal-dialog
      div.modal-content
        div.modal-header
          h5.modal-title Delete Employee
          button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
        div.modal-body
          p Are you sure you want to delete this employee?
        div.modal-footer
          button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
          button#confirmDelete.btn.btn-danger(type="button") Delete

  block scripts
    script.
      $(document).ready(function() {
        const table = $('#empTable').DataTable({
          pageLength: 5,
          lengthChange: false,
          columnDefs: [
            { orderable: false, targets: 5 }
          ]
        });

        $('#statusFilter').on('change', function() {
          const val = this.value;
          if(val === 'all') {
            table.column(4).search('').draw();
          } else if(val === '1') {
            table.column(4).search('Active').draw();
          } else {
            table.column(4).search('Inactive').draw();
          }
        });

        $('#nameSearch').on('keyup', function() {
          table.column(1).search(this.value).draw();
        });

        let deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        let employeeToDeleteId = null;

        window.showDeleteModal = function(employeeId) {
          employeeToDeleteId = employeeId;
          deleteModal.show();
        }

        $('#confirmDelete').on('click', function() {
          if(!employeeToDeleteId) return;

          fetch(`/employee/delete/${employeeToDeleteId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
              if(data.success) {
                table
                  .rows(function(idx, data, node) {
                    return $(node).find('button.btn-danger').attr('onclick').includes(employeeToDeleteId);
                  })
                  .remove()
                  .draw();

                deleteModal.hide();
              } else {
                alert('Error deleting employee: ' + data.error);
              }
            })
            .catch(err => {
              console.error(err);
              alert('Error deleting employee.');
            });
        });

        window.editEmployee = function(employeeId) {
          window.location.href = `/employee/create?id=${employeeId}`;          
        }
      });
